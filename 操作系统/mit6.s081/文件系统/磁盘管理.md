磁盘被分成了许多磁盘块，**对已经使用的磁盘块**采用索引结构管理：通过为每一个文件建立一个索引数据结构，存放了文件使用的磁盘块的地址。（一个磁盘块是512b-4kb），如下图所示，包括直接索引，一级索引，二级索引等。
**对于未使用的磁盘块有几种方式进行管理：**
**1、空闲链表法**。将所有的空闲块形成一条链表，将第一个空闲块保留在磁盘中，同时也放入内存中。

**2、空闲区表法**，磁盘上一段连续的未分配区域叫做空闲区，空闲区表属于连续分配的方式，具体做法是建立一张表，记录第一个空闲块的块号和连续空闲块个数。

**3、位图法**。用一个 bit 来表示一个磁盘块的使用情况，1 代表使用，0 代表空闲。

方法1和2不适合大型文件系统，链表过长，空闲表过大。3会增加CPU的计算时间
![[Pasted image 20230830172203.png]]
## 磁盘的总体布局
![[Pasted image 20230830172538.png]]
**boot**：操作系统引导块
**super**：描述整个文件系统的信息，就一个结构体
**log**：崩溃恢复用的，对多个磁盘块的写入操作是需要先写入log，等log提交到磁盘，写入操作被认为成功写入磁盘，才可以提交。
**inodes**：存储inode地方，也就是存储文件的地方，包括了一个文件除文件名之外的所有信息， 主要包括文件大小，拥有者组的 ，读写执行权限，时间戳等属性信息，还有就是数据块指针。
**bitmap**：每个磁盘块的使用情况。
**data**：存放文件数据。
## 磁盘驱动程序
virtio.c包括的函数有virtio_disk_init、alloc_desc、free_desc、free_chain、alloc3_desc、virtio_disk_rw、virtio_disk_intr。

**virtio_disk_init**：初始化VirtIO设备结构体的字段，包括获取PCI设备的信息，映射VirtIO设备的I/O内存空间，初始化设备的状态，启用设备的中断等。使用virtio_ring_init()函数初始化VirtIO的I/O队列，包括描述符表，可用环和已用环。向设备发送"驱动程序就绪"的通知，以使设备进入工作状态。

**alloc_desc和free_desc**：在描述符环中分配新的描述符的函数。描述符环是一种特殊的数据结构，用于描述需要异步处理的数据块和相关的处理操作，例如I/O操作。

**free_chain**：用于释放一条描述符链表（descriptor chain）的函数

**alloc3_desc**：

**virtio_disk_rw**：是 virtio 磁盘驱动的核心函数，用于向磁盘发送读/写请求，并等待磁盘完成请求后，将读取的数据写入缓冲区。