
![[Pasted image 20230831223513.png|磁盘总体布局]]
如果一个操作涉及到对磁盘不同的块的读写操作，写的过程中系统崩溃，磁盘的数据一致性很难保证，因此保证对多个磁盘块的写操作的原子性就很重要了。通过日志来解决因为崩溃导致的不一致问题，保证了多个写操作的原子性。

操作系统先将对缓存块写入磁盘操作包装成一个日志操作，写入到日志区，等到日志提交到磁盘区，对缓冲块的写操作才算完成。
```c
struct superblock {
  uint magic;        // Must be FSMAGIC  
  uint size;         // Size of file system image (blocks)  
  uint nblocks;      // Number of data blocks  
  uint ninodes;      // Number of inodes.  
  uint nlog;         // Number of log blocks  
  uint logstart;     // Block number of first log block  
  uint inodestart;   // Block number of first inode block  
  uint bmapstart;    // Block number of first free map block  
}
struct logheader {
  int n; //当前日志使用空间大小
  int block[LOGSIZE]; //Block[1] = 1024表示日志块1记录的数据放在1024号磁盘块
};
struct log {
  struct spinlock lock;
  int start;//日志区第一块块号
  int size;//日志区大小
  int outstanding; // 有多少文件系统调用正在执行  
  int committing;  // 正在提交
  int dev;//设备，即主盘还是从盘，文件系统在从盘
  struct logheader lh;//日志头
}
```
日志操作

